---
import { events } from "@hina-is/bestdori/data";
import { unwrap } from "@hina-is/bestdori/utilities";

import BaseLayout from "~/layouts/base-layout.astro";
import { IMAGE_FORMAT } from "~/lib/compressor/constants";
import { dayjs } from "~/lib/date";
import { paginate } from "~/lib/paginate";
import EventCard from "./_event-card.astro";

const event = (() => {
	const active = [] as number[];
	const upcoming = [] as number[];

	const now = dayjs();
	let lastEndAt: dayjs.Dayjs;
	for (const [id, { startAt, endAt }] of [...events.entries()]) {
		if (!startAt.en || !endAt.en) {
			upcoming.push(id);
			continue;
		} else if (
			now.isBefore(startAt.en) ||
			now.isBetween(startAt.en, endAt.en)
		) {
			active.push(id);
		}

		lastEndAt = dayjs(endAt.en);
	}

	return {
		active: active.map((id) => ({ id, ...events.get(id)! })),
		upcoming: upcoming.map((id) => {
			const { startAt, endAt, ...event } = events.get(id)!;

			const eventDuration = dayjs(endAt.jp).diff(startAt.jp);
			const startAtEn = lastEndAt.startOf("hours").add(43, "hours");
			const endAtEn = startAtEn.add(eventDuration);
			lastEndAt = endAtEn;

			return {
				id,
				startAt: { ...startAt, en: startAtEn.toDate() },
				endAt: { ...endAt, en: endAtEn.toDate() },
				...event,
			};
		}),
	};
})();

const upcomingEvents = paginate({
	items: event.upcoming,
	context: Astro,
	size: 6,
	extraProps: { "hx-select": "#upcoming-events > *", "hx-swap": "afterend" },
});
---

<BaseLayout
	background={event.active.length > 0
		? {
				src: `/assets/event/${event.active[0].id}_background.${IMAGE_FORMAT}`,
				alt: `${unwrap(event.active[0].name)} background`,
			}
		: undefined}
>
	<div class="flex flex-col gap-8">
		<div class="flex flex-col items-center gap-4">
			<h2 class="badge badge-accent badge-xl font-medium">Active events</h2>

			<div id="active-events" class="flex flex-wrap justify-center gap-2">
				{
					event.active.length > 0 ? (
						event.active.map((event) => <EventCard {event} predicted={false} />)
					) : (
						<p class="text-base-content/50">No active event at the moment.</p>
					)
				}
			</div>
		</div>

		<div class="flex flex-col items-center gap-4">
			<h2 class="badge badge-accent badge-xl font-medium">Upcoming events</h2>

			<div
				id="upcoming-events"
				hx-indicator="#upcoming-events-loader"
				class="flex flex-wrap justify-center gap-2"
			>
				{
					upcomingEvents.items.map((event, idx) => (
						<EventCard
							{...(upcomingEvents.isLastElement(idx) && upcomingEvents.props)}
							{event}
							predicted
						/>
					))
				}
			</div>

			<div
				id="upcoming-events-loader"
				class="htmx-indicator relative mt-8 h-32 w-full"
			>
				<iconify-icon
					icon="svg-spinners:90-ring-with-bg"
					width="none"
					class="text-accent center bg-accent-content/80 absolute size-32 rounded-full"
				></iconify-icon>

				<span
					class="badge center badge-lg badge-accent absolute w-max font-medium"
					>loading more events...</span
				>
			</div>
		</div>
	</div>
</BaseLayout>
