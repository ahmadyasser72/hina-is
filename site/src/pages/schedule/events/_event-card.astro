---
import type { Bandori } from "@hina-is/bestdori/data";
import { unwrap } from "@hina-is/bestdori/utilities";

import { colord } from "colord";

import { IMAGE_FORMAT } from "~/lib/compressor/constants";
import EventCardTime from "./_event-card-time.astro";

interface Props {
	event: Bandori.Event & { id: number };
	predicted: boolean;
}

const { event, predicted, ...props } = Astro.props;

const eventBand = event.characters
	.slice(1)
	.every(({ band }) => band.id === event.characters[0].band.id)
	? { type: "one" as const, data: event.characters[0].band }
	: {
			type: "multiple" as const,
			data: Object.entries(
				Object.groupBy(event.characters, ({ band }) => band.id),
			).map(([, character]) => ({
				count: character!.length,
				...character![0].band,
			})),
		};
---

<div class="card bg-base-100 w-90 shadow-sm" {...props}>
	<figure>
		<img
			src={`/assets/event/${event.id}_banner.${IMAGE_FORMAT}`}
			alt={`${unwrap(event.name)} banner`}
			loading="lazy"
			class="aspect-3/1 h-32"
		/>
	</figure>
	<div class="card-body items-center text-center">
		<h2 class="card-title flex-1">
			{unwrap(event.name)}
		</h2>

		<EventCardTime startAt={event.startAt} endAt={event.endAt} region="jp" />

		<EventCardTime
			startAt={event.startAt}
			endAt={event.endAt}
			region="en"
			{predicted}
		/>

		<div class="flex flex-wrap justify-center gap-1">
			<div class="badge dark:badge-primary dark:badge-soft font-medium">
				<div
					class="tooltip before:text-white"
					data-tip={event.attribute.name.toUpperCase()}
					style={`--tt-bg: ${event.attribute.color}`}
				>
					<img
						src={`/assets/attribute/${event.attribute.name}.svg`}
						alt=`${event.attribute.name.toUpperCase()} icon`
						loading="lazy"
						class="size-5"
					/>
				</div>

				{event.type}
			</div>

			<div
				class:list={[
					"badge font-medium",
					eventBand.type === "multiple" && "dark:badge-primary dark:badge-soft",
					eventBand.type === "one" &&
					colord(eventBand.data.color!).brightness() < 0.67
						? "text-white"
						: "text-black",
				]}
				style={eventBand.type === "one" &&
					`--badge-bg: ${eventBand.data.color!}`}
			>
				{
					eventBand.type === "multiple" &&
						eventBand.data
							.map(({ color, ...band }) => ({ ...band, color: colord(color!) }))
							.map(({ id, name, color, count }, idx) => (
								<div
									class:list={[
										"tooltip",
										idx % 2 && "tooltip-bottom",
										color.brightness() < 0.67
											? "before:text-white"
											: "before:text-black",
									]}
									data-tip={`${unwrap(name)} (${count})`}
									style={`--tt-bg: ${color.toHex()}`}
								>
									<img
										src={`/assets/band/${id}.svg`}
										alt={`${unwrap(name)} icon`}
										loading="lazy"
										class="size-5"
									/>
								</div>
							))
				}

				{
					eventBand.type === "one" && (
						<>
							<img
								src={`/assets/band/${eventBand.data.id}.svg`}
								alt={`${unwrap(eventBand.data.name)} icon`}
								loading="lazy"
								class:list={[
									"size-5",
									colord(eventBand.data.color!).brightness() > 0.67 &&
										"dark:drop-shadow-lg",
								]}
							/>

							{unwrap(eventBand.data.name)}
						</>
					)
				}
			</div>
		</div>

		<div class="flex flex-wrap justify-center gap-1">
			{
				event.characters
					.map(({ id, nickname, name, band, colorCode }) => ({
						id,
						name: unwrap(nickname) ?? unwrap(name),
						band: unwrap(band.name),
						color: colord(colorCode),
					}))
					.map(({ id, name, band, color }, idx) => (
						<div
							class:list={[
								"tooltip",
								idx % 2 && "tooltip-bottom",
								color.isDark() ? "before:text-white" : "before:text-black",
							]}
							data-tip={
								eventBand.type === "multiple" ? `${name} / ${band}` : name
							}
							style={`--tt-bg: ${color.toHex()}`}
						>
							<img
								src={`/assets/character/${id}.${IMAGE_FORMAT}`}
								alt={`${name} icon`}
								loading="lazy"
								class="size-10"
							/>
						</div>
					))
			}
		</div>
	</div>
</div>
