---
import { titleCase } from "text-case";

import { filterEvents, getEvents } from "../_list";
import { schema } from "../_params";

export const partial = true;

const params = Astro.locals.parseQuery(schema);
const events = getEvents(params);
const { facets } = filterEvents(params, events.list);
---

<dialog id="filter_modal" class="modal max-sm:modal-bottom">
	<div class="modal-box max-h-4/5 w-full sm:max-w-xl">
		<h3 class="text-center text-lg font-medium">Filter {params.list} events</h3>

		<form
			id="filter"
			class="flex flex-col gap-1"
			hx-get="/page/events/filter"
			hx-trigger="input"
			hx-select="#filter"
			hx-select-oob="#apply-filter"
			hx-swap="outerHTML transition:true"
			hx-vals={JSON.stringify({ list: params.list })}
		>
			{
				facets.map(({ name, type, values }) => (
					<fieldset class="group fieldset border-base-300 rounded-box w-full border p-4 pt-2">
						<legend class="fieldset-legend">{titleCase(name)}</legend>

						<div class="flex flex-wrap gap-1">
							{values.map(({ id, value, label, icon, count }) => (
								<div>
									<input
										{id}
										{name}
										{value}
										{type}
										checked={
											Array.isArray(params[name])
												? params[name].includes(value as never)
												: params[name] === value
										}
										class="peer hidden"
									/>
									<label
										for={id}
										class="btn max-sm:btn-sm not-peer-checked:btn-outline peer-checked:btn-accent"
									>
										{icon && (
											<img
												src={icon}
												alt={`${label} icon`}
												class="size-6 sm:size-8"
											/>
										)}
										{label} ({count})
									</label>
								</div>
							))}

							{params[name] && (
								<input
									{name}
									{type}
									value="reset"
									class="btn max-sm:btn-sm"
									aria-label="Reset"
								/>
							)}
						</div>
					</fieldset>
				))
			}
		</form>

		<div class="bg-base-100 sticky bottom-0 w-full px-4 py-2">
			<button
				id="apply-filter"
				class="btn btn-primary w-full"
				hx-get="/page/events"
				hx-indicator="this"
				hx-vals={JSON.stringify(params)}
				hx-select-oob="#events-heading, #events"
				hx-swap="none transition:true"
				hx-on--after-request="event.detail.successful && filter_modal.close()"
			>
				<iconify-icon
					icon="lucide:filter"
					width="none"
					class="htmx-indicator-replace size-6"></iconify-icon>
				<iconify-icon
					icon="svg-spinners:90-ring-with-bg"
					width="none"
					class="htmx-indicator size-6"></iconify-icon>

				Apply filter
			</button>
		</div>
	</div>

	<form method="dialog" class="modal-backdrop">
		<button>close</button>
	</form>
</dialog>
