---
import { headerCase } from "text-case";

import { filterEvents, getEvents } from "../_list";
import { schema } from "../_params";
import FilterFieldset from "./_filter-fieldset.astro";

export const partial = true;

const params = Astro.locals.parseQuery(schema);
const events = getEvents(params);
const { facets } = await filterEvents(params, events.list);
---

<dialog class="modal max-sm:modal-bottom" id="filter_modal">
	<div class="modal-box max-h-4/5 w-full sm:max-w-xl">
		<h3 class="text-center text-lg font-medium">Filter {params.list} events</h3>

		<form
			class="flex flex-col gap-1"
			id="filter"
			hx-disabled-elt="#filter input"
			hx-include="#filter"
			hx-select="#filter"
			hx-select-oob="#apply-filter"
			hx-swap="outerHTML transition:true"
			hx-target="this"
			hx-vals={JSON.stringify({ list: params.list })}
		>
			<FilterFieldset name="attribute" {facets} {params} />
			<FilterFieldset name="event_type" {facets} {params} />

			<FilterFieldset name="band" {facets} {params}>
				<div class="join">
					{
						schema.shape.band_type.def.innerType.options.map((value) => (
							<input
								hx-get="/page/events/filter"
								class="join-item btn btn-sm checked:btn-accent"
								name="band_type"
								type="radio"
								{value}
								aria-label={headerCase(value)}
								checked={params.band_type === value}
								disabled={
									params.filter_stamp ||
									(params.band_type !== value &&
										params.character &&
										params.character.length > 1)
								}
							/>
						))
					}
				</div>
			</FilterFieldset>

			<FilterFieldset name="character" {facets} {params}>
				<div class="mb-1 flex gap-2">
					<label class="label">
						<input
							hx-get="/page/events/filter"
							class="toggle toggle-sm"
							name="filter_stamp"
							type="checkbox"
							checked={params.filter_stamp}
						/>
						Filter Stamp
					</label>
				</div>
			</FilterFieldset>
		</form>

		<div class="bg-base-100 join sticky bottom-0 w-full px-4 py-2">
			<button
				hx-get="/page/events"
				class="btn btn-primary join-item flex-1"
				id="apply-filter"
				hx-indicator="this"
				hx-on--after-request="event.detail.successful && filter_modal.close()"
				hx-select="#events"
				hx-swap="outerHTML show:top"
				hx-target="#events"
				hx-vals={JSON.stringify(params)}
			>
				<iconify-icon
					class="htmx-indicator-replace size-6"
					icon="lucide:filter"
					width="none"></iconify-icon>
				<iconify-icon
					class="htmx-indicator size-6"
					icon="svg-spinners:90-ring-with-bg"
					width="none"></iconify-icon>

				Apply
			</button>

			<button
				hx-get="/page/events/filter"
				class="btn btn-error join-item"
				id="reset-filter"
				hx-swap="outerHTML transition:true"
				hx-target="closest dialog"
				hx-vals={JSON.stringify(schema.parse({}))}
			>
				<iconify-icon
					class="htmx-indicator-replace size-6"
					icon="lucide:rotate-ccw"
					width="none"></iconify-icon>
				<iconify-icon
					class="htmx-indicator size-6"
					icon="svg-spinners:90-ring-with-bg"
					width="none"></iconify-icon>

				Reset
			</button>
		</div>
	</div>

	<form class="modal-backdrop" method="dialog">
		<button>close</button>
	</form>
</dialog>
