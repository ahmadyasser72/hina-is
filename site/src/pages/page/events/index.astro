---
import { unwrap } from "@hina-is/bestdori/utilities";

import { titleCase } from "text-case";

import BaseLayout from "~/layouts/base-layout.astro";
import { IMAGE_FORMAT } from "~/lib/compressor/constants";
import { paginate } from "~/lib/paginate";
import EventCard from "./_event-card.astro";
import { filterEvents, getEvents } from "./_list";
import { schema } from "./_params";

const params = Astro.locals.parseQuery(schema);
const oppositeList = params.list === "future" ? "past" : "future";

const events = getEvents(params);
const { filtered } = filterEvents(params, events.list);
const page = paginate({
	items: filtered,
	context: Astro,
	size: 6,
	extraProps: {
		"hx-select": "#events > *",
		"hx-swap": "afterend",
		"hx-vals": JSON.stringify(params),
	},
});
---

<BaseLayout
	background={events.active.length > 0
		? {
				src: `/assets/event/${events.active[0].id}_background.${IMAGE_FORMAT}`,
				alt: `${unwrap(events.active[0].name)} background`,
			}
		: undefined}
>
	<div class="flex flex-col gap-8">
		<div class="flex flex-col items-center gap-4">
			<h2 class="badge badge-accent badge-xl w-48 font-medium">
				Active events
			</h2>

			<div
				id="active-events"
				class="flex flex-wrap justify-center gap-x-2 gap-y-4"
			>
				{
					events.active.length > 0 ? (
						events.active.map((event) => (
							<EventCard {event} predicted={false} />
						))
					) : (
						<p class="text-base-content/50">No active event at the moment.</p>
					)
				}
			</div>
		</div>

		<div class="flex flex-col items-center gap-4">
			<div id="events-heading" class="inline-flex gap-2">
				<div
					class="tooltip tooltip-right"
					data-tip={`Filter ${params.list} events`}
				>
					<button
						class="btn btn-sm btn-circle btn-success"
						hx-get="/page/events/filter"
						hx-indicator="this"
						hx-vals={JSON.stringify(params)}
					>
						<iconify-icon
							icon="lucide:list-filter"
							width="none"
							class="htmx-indicator-replace size-4"></iconify-icon>
						<iconify-icon
							icon="svg-spinners:90-ring-with-bg"
							width="none"
							class="htmx-indicator size-4"></iconify-icon>
					</button>
				</div>

				<h2 class="badge badge-accent badge-xl w-48 font-medium">
					{titleCase(params.list)} events
				</h2>

				<div
					class="tooltip tooltip-left"
					data-tip={`Show ${oppositeList} events`}
				>
					<button
						class="btn btn-sm btn-circle btn-success"
						hx-get
						hx-indicator="this"
						hx-vals={JSON.stringify({ ...params, list: oppositeList })}
						hx-select-oob="#events-heading, #events"
						hx-swap="none transition:true"
					>
						<iconify-icon
							icon={oppositeList === "future"
								? "lucide:calendar-clock"
								: "lucide:history"}
							width="none"
							class="htmx-indicator-replace size-4"></iconify-icon>
						<iconify-icon
							icon="svg-spinners:90-ring-with-bg"
							width="none"
							class="htmx-indicator size-4"></iconify-icon>
					</button>
				</div>
			</div>

			<div
				id="events"
				hx-indicator="#events-loader"
				class="flex flex-wrap justify-center gap-x-2 gap-y-4"
			>
				{
					page.items.map((event, idx) => (
						<EventCard
							{...(page.isLastElement(idx) && page.props)}
							{event}
							predicted={params.list === "future"}
						/>
					))
				}
			</div>

			<div id="events-loader" class="htmx-indicator relative mt-8 h-32 w-full">
				<iconify-icon
					icon="svg-spinners:90-ring-with-bg"
					width="none"
					class="text-accent center bg-accent-content/80 absolute size-32 rounded-full"
				></iconify-icon>

				<span
					class="badge center badge-lg badge-accent absolute w-max font-medium"
					>loading more events...</span
				>
			</div>
		</div>
	</div>
</BaseLayout>
