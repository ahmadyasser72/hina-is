---
import type { Bandori } from "@hina-is/bestdori/data";

import { colord } from "colord";

import { IMAGE_FORMAT } from "~/lib/compressor/constants";
import { dayjs, formatDuration } from "~/lib/date";
import EventCardBandIcon from "./_event-card-band-icon.astro";
import EventCardCharacterIcon from "./_event-card-character-icon.astro";
import EventCardTime from "./_event-card-time.astro";

interface Props {
	event: Bandori.Event & { id: number };
	predicted: boolean;
}

const { event, predicted, ...props } = Astro.props;
const { attribute, band, characters, startAt, endAt } = event;

const progress = (() => {
	if (predicted || !startAt.en || !endAt.en) return;

	const now = dayjs();
	const start = dayjs(startAt.en);
	const end = dayjs(endAt.en);

	if (now.isAfter(end)) return;
	else if (now.isBefore(start)) {
		const untilStarted = formatDuration(now, start);
		return { tooltip: `Starts in ${untilStarted}` };
	}

	const duration = end.diff(start);
	const passed = now.diff(start);
	const untilEnded = formatDuration(now, end);
	return {
		value: ((passed / duration) * 100).toFixed(1),
		tooltip: `Ends in ${untilEnded}`,
	};
})();
---

<div class="event-card flex flex-col gap-1" {...props}>
	<div class="card bg-base-100 w-90 flex-1 shadow-sm">
		<figure>
			<img
				class="aspect-3/1 h-32"
				src={`/assets/events/${event.slug}-banner.${IMAGE_FORMAT}`}
				alt={`${event.name} banner`}
				loading="lazy"
			/>
		</figure>
		<div class="card-body items-center text-center">
			<h2 class="card-title flex-1">
				{event.name}
			</h2>

			<EventCardTime {endAt} region="jp" {startAt} />

			<EventCardTime {endAt} {predicted} region="en" {startAt} />

			<div class="flex flex-wrap justify-center gap-1">
				<div class="badge dark:badge-primary dark:badge-soft font-medium">
					<div
						class="tooltip before:text-white"
						data-tip={attribute.name.toUpperCase()}
						style={`--tt-bg: ${attribute.color}`}
					>
						<img
							class="size-5"
							src={`/assets/attributes/${attribute.name}.svg`}
							alt=`${attribute.name.toUpperCase()} icon`
							loading="lazy"
						/>
					</div>

					{event.type}
				</div>

				{
					Array.isArray(band) ? (
						<div class="badge dark:badge-primary dark:badge-soft">
							{band.map((band) => (
								<EventCardBandIcon {band} />
							))}
						</div>
					) : (
						<div
							class:list={[
								"badge font-medium",
								colord(band.color!).brightness() < 0.67
									? "text-white"
									: "text-black",
							]}
							style={`--badge-bg: ${band.color!}`}
						>
							<img
								src={`/assets/bands/${band.slug}.svg`}
								alt={`${band.name} icon`}
								class:list={[
									"size-5",
									colord(band.color!).brightness() > 0.67 &&
										"dark:drop-shadow-lg",
								]}
								loading="lazy"
							/>

							{band.name}
						</div>
					)
				}
			</div>

			<div class="flex flex-wrap justify-center gap-1">
				{
					characters.length > 5 ? (
						<>
							{characters.slice(0, 4).map((character) => (
								<EventCardCharacterIcon
									{character}
									displayBand={Array.isArray(band)}
									tooltip="bottom"
								/>
							))}

							<details class="dropdown dropdown-top dropdown-end">
								<summary class="btn btn-circle btn-outline size-10">
									<iconify-icon
										class="size-4"
										icon="lucide:chevron-up"
										width="none"
									/>
								</summary>
								<div class="dropdown-content bg-base-100 rounded-box mb-2 flex w-60 flex-wrap justify-center gap-1 p-2 shadow-sm">
									{characters.slice(4).map((character) => (
										<EventCardCharacterIcon
											{character}
											displayBand={Array.isArray(band)}
											tooltip="top"
										/>
									))}
								</div>
							</details>
						</>
					) : (
						characters.map((character) => (
							<EventCardCharacterIcon
								{character}
								displayBand={Array.isArray(band)}
							/>
						))
					)
				}
			</div>

			{
				progress && (
					<div class="tooltip relative w-full" data-tip={progress.tooltip}>
						<progress
							class="progress progress-primary w-full"
							value={progress.value}
							max="100"
						/>

						<span class="center bg-secondary rounded-field text-secondary-content absolute w-14 font-medium">
							{progress.value}%
						</span>
					</div>
				)
			}
		</div>
	</div>

	<div class="join">
		<a
			class="btn join-item btn-sm btn-info flex-1"
			href={`https://bestdori.com/info/events/${event.id}`}
			rel="noopener noreferrer"
			target="_blank"
		>
			<iconify-icon class="size-4" icon="lucide:external-link" width="none"
			></iconify-icon>
			View on Bestdori!
		</a>

		<div class="dropdown dropdown-end dropdown-top">
			<div
				class="btn join-item btn-sm btn-circle btn-soft"
				role="button"
				tabindex="0"
			>
				<iconify-icon class="size-4" icon="lucide:ellipsis" width="none"
				></iconify-icon>
			</div>
			<ul
				class="dropdown-content menu bg-base-200/80 rounded-box z-10 mb-1 w-max p-2 shadow-sm"
				tabindex="-1"
			>
				<li>
					<a
						href={`https://bestdori.com/tool/eventtracker/jp/t10/${event.id}`}
						rel="noopener noreferrer"
						target="_blank">T10 Leaderboard (JP)</a
					>
				</li>
				{
					dayjs(event.startAt.en).isBefore() && (
						<li>
							<a
								href={`https://bestdori.com/tool/eventtracker/en/t10/${event.id}`}
								rel="noopener noreferrer"
								target="_blank"
							>
								T10 Leaderboard (EN)
							</a>
						</li>
					)
				}
			</ul>
		</div>
	</div>
</div>
